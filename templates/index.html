<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic FinCompute</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="logo-section">
            <div class="logo-icon">‡•ê</div>
            <div class="logo-text">
                <h1>Vedic <span>FinCompute</span></h1>
                <p>POWERED BY NIKHILAM NAVATASHCARAMAM DASHATAH</p>
            </div>
        </div>
        <div class="login-section">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('dashboard') }}" class="agent-link">{{ current_user.username }}</a>
            {% else %}
                <a href="{{ url_for('login') }}" class="agent-link">Agent Login</a>
            {% endif %}
        </div>
    </div>
    
    <div class="calculator-form">
        <div class="input-group">
            <label>üè¶ Principal Amount (‚Çπ)</label>
            <input type="range" id="pSlider" min="10000" max="10000000" step="5000" value="500000">
            <input type="number" id="principal" value="500000">
        </div>
        
        <div class="input-group">
            <label>üßÆ Annual Interest Rate (%)</label>
            <input type="range" id="rSlider" min="1" max="25" step="0.1" value="8.5">
            <input type="number" id="rate" step="0.1" value="8.5">
        </div>
        
        <div class="input-group">
            <label>üóìÔ∏è Tenure (Years)</label>
            <input type="range" id="tSlider" min="1" max="30" step="1" value="5">
            <input type="number" id="years" value="5">
        </div>

        <button class="calc-btn" onclick="calculateEMI()" id="calcBtn">CALCULATE EMI</button>
    </div>

    <div class="result-card" id="resultBox" style="display:none;">
        <div class="result-header-text">ESTIMATED MONTHLY INSTALLMENT</div>
        <div class="main-emi" id="emiDisplay">‚Çπ0</div>
        
        <div class="chart-container">
            <canvas id="emiChart"></canvas>
        </div>

        <div class="totals-grid">
            <div class="total-block">
                <div class="total-label">PRINCIPAL AMOUNT</div>
                <div class="total-value mustard" id="pDisp">‚Çπ0</div>
                <div class="progress-bar mustard-bar"></div>
            </div>
            <div class="total-block">
                <div class="total-label">TOTAL INTEREST</div>
                <div class="total-value teal" id="iDisp">‚Çπ0</div>
                <div class="progress-bar teal-bar"></div>
            </div>
        </div>

        <div class="metrics-footer">
            <div class="metric">Latency: <span id="lat">0 Œºs</span></div>
            <div class="metric">Algorithm: Nikhilam Sutra (Vedic)</div>
        </div>

        {% if current_user.is_authenticated %}
        <div class="save-section">
            <input type="text" id="cName" placeholder="Client Name">
            <input type="text" id="cPhone" placeholder="Client Phone">
            <button class="save-btn" onclick="saveData()">Save Record</button>
        </div>
        {% endif %}
    </div>

    <div class="bottom-footer">
        NIKHILAM NAVATASHCARAMAM DASHATAH<br>
        HIGH PRECISION CALCULATIONS FOR MODERN FINANCE
    </div>
</div>



<script>
    let emiChart;

    // --- Slider & Input Synchronization ---
    function setupSync(sliderId, inputId) {
        const s = document.getElementById(sliderId);
        const n = document.getElementById(inputId);
        s.oninput = () => { n.value = s.value; };
        n.oninput = () => { s.value = n.value; };
        s.onchange = calculateEMI; // Auto-calculate on slider release
        n.onchange = calculateEMI;
    }

    setupSync('pSlider', 'principal');
    setupSync('rSlider', 'rate');
    setupSync('tSlider', 'years');

    // --- Core Calculation Call ---
    async function calculateEMI() {
        const p = parseFloat(document.getElementById('principal').value);
        const r = parseFloat(document.getElementById('rate').value);
        const t = parseFloat(document.getElementById('years').value);
        
        if(!p || !r || !t) return;

        try {
            const res = await fetch('/calculate/emi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ principal: p, rate: r, years: t })
            });

            const data = await res.json();
            const totalInterest = (data.emi * t * 12) - p;

            // Update UI Numbers
            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('emiDisplay').innerText = "‚Çπ" + Math.round(data.emi).toLocaleString('en-IN');
            document.getElementById('pDisp').innerText = "‚Çπ" + p.toLocaleString('en-IN');
            document.getElementById('iDisp').innerText = "‚Çπ" + Math.round(totalInterest).toLocaleString('en-IN');
            document.getElementById('lat').innerText = data.latency_microseconds + " Œºs";
            
            // Update Donut Chart
            updateDonut(p, totalInterest);
            
        } catch (e) { console.error("Calc Error:", e); }
    }

    // --- Chart.js Donut Logic ---
    function updateDonut(principal, interest) {
        const ctx = document.getElementById('emiChart').getContext('2d');
        if (emiChart) {
            emiChart.data.datasets[0].data = [principal, interest];
            emiChart.update();
        } else {
            emiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Principal', 'Interest'],
                    datasets: [{
                        data: [principal, interest],
                        backgroundColor: ['#e1ad01', '#00e5ff'], // Mustard and Teal
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    cutout: '75%', // Creates the thin ring look
                    plugins: { legend: { display: false } },
                    animation: { animateScale: true }
                }
            });
        }
    }

    // --- Save Data Logic ---
    async function saveData() {
        const name = document.getElementById('cName').value;
        const phone = document.getElementById('cPhone').value;
        const emiVal = document.getElementById('emiDisplay').innerText.replace(/[‚Çπ,]/g, '');
        
        if(!name || !phone) { alert("Enter client details"); return; }

        const res = await fetch('/save_client', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name, phone, emi: parseFloat(emiVal),
                principal: document.getElementById('principal').value,
                rate: document.getElementById('rate').value,
                years: document.getElementById('years').value
            })
        });
        if(res.ok) window.location.href = "/dashboard";
    }
</script>
</body>
</html>